name: Run Tests and Open PR

on:
  push:
    branches:
      - tests

permissions:
  contents: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
          allow-prereleases: true

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install --with-deps chromium

      - name: Install Allure CLI
        run: npm install -g allure-commandline

      - name: Run UI tests
        id: run_ui_tests
        run: |
          python -m pytest tests/serverrest/ui/ -q -m ui --junitxml=report-ui.xml --alluredir=allure-results || true

      - name: Run API tests
        id: run_api_tests
        run: |
          python -m pytest tests/serverrest/api/ -q -m api --junitxml=report-api.xml --alluredir=allure-results || true

      - name: Merge XML reports
        run: |
          python -c "
          import xml.etree.ElementTree as ET
          import glob, os

          reports = glob.glob('report-*.xml')
          if not reports:
              print('No reports found')
              exit(0)

          merged = ET.Element('testsuites')
          for path in reports:
              tree = ET.parse(path)
              root = tree.getroot()
              if root.tag == 'testsuite':
                  merged.append(root)
              else:
                  for ts in root.findall('testsuite'):
                      merged.append(ts)

          ET.ElementTree(merged).write('report.xml')
          print(f'Merged {len(reports)} report(s) into report.xml')
          "

      - name: Generate Allure Report
        if: always()
        run: allure generate allure-results --clean -o allure-report

      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/

      - name: Check success rate
        id: check
        run: |
          python -c "
          import xml.etree.ElementTree as ET
          import os

          tree = ET.parse('report.xml')
          root = tree.getroot()
          ts = root if root.tag == 'testsuite' else root.find('testsuite')
          total = int(ts.get('tests', 0))
          failures = int(ts.get('failures', 0))
          errors = int(ts.get('errors', 0))
          passed = total - failures - errors
          rate = (passed / total * 100) if total > 0 else 0

          print(f'Total: {total} | Passed: {passed} | Failed: {failures} | Errors: {errors}')
          print(f'Success rate: {rate:.1f}%')

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'success_rate={rate:.1f}\n')
              f.write(f'should_pr={\"true\" if rate >= 75 else \"false\"}\n')
          "

      - name: Open PR to main
        if: steps.check.outputs.should_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Success rate: ${{ steps.check.outputs.success_rate }}% - Opening PR"
          gh pr create \
            --base main \
            --head tests \
            --title "Merge tests - ${{ steps.check.outputs.success_rate }}% passing" \
            --body "Automated PR. Success rate: ${{ steps.check.outputs.success_rate }}% (threshold: 75%)" \
            || echo "PR already exists or could not be created"

      - name: Fail if below threshold
        if: steps.check.outputs.should_pr == 'false'
        run: |
          echo "Test failed: success rate ${{ steps.check.outputs.success_rate }}% is below 75% threshold"
          exit 1